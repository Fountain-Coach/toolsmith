# Toolsmith Implementation Audit — 2025-10-04

This document summarizes the current implementation status of the Toolsmith package and its alignment with the Toolsmith Agent Guide, and reviews the companion image repository `fountainkit-toolsmith-image`.

## Summary

- VM hydration, caching, checksum verification, and boot orchestration are implemented with lifecycle logging.
- Default execution resolves to VM when a manifest is present and falls back to host if unavailable or on error.
- Workspace mounts into the guest are read-only by default; optional writable exports are plumbed.
- Command channel adapter is currently a stub and does not yet connect to a real guest-side service.
- Build now succeeds on Swift 6 after a minimal Sendable fix; some tests fail on macOS due to unconditional `FoundationNetworking` imports.
- The image repo provides solid scaffolding (build, validation, docs) but publishes a catalog-style manifest that does not yet match the consuming `.toolsmith/tools.json` shape.

## VM-first Execution Model

- Hydration and caching
  - Image cache path: `.toolsmith/cache/<image>/<qcow2_sha256>/<qcow2>` (Sources/Toolsmith/Virtualization/ImageHydrator.swift)
  - Verifies SHA-256 via `ToolManifest.verify(fileAt:)` (Sources/ToolsmithSupport/ToolManifest.swift)
  - Resolves local vs remote source and hydrates accordingly.
- Execution mode resolution
  - `TOOLSMITH_EXECUTION` env: `host|vm|automatic` (Sources/Toolsmith/Toolsmith.swift:157)
  - Default: `.automatic` resolving to `.vm` when a manifest is found, else `.host`.
- Boot and workspace mounts
  - QEMU launched with `-virtfs` mounts for `work` and `scratch` as read-only (Sources/SandboxRunner/QemuRunner.swift)
  - Optional writable exports supported via `QemuRunner.ExportMount` and `VirtualMachine.start(writableExports:)`.
- Command channel
  - Host forwards a random TCP port to guest `:3023` (Sources/SandboxRunner/QemuRunner.swift: command channel port mapping)
  - Adapter (`CommandChannelAdapter`) currently yields `started` and `finished(0)` without guest I/O; no real transport yet (Sources/Toolsmith/Adapters/CommandChannelAdapter.swift).

## Coding & Testing Standards

- Formatting
  - Swift sources formatted with `swift format --in-place` during this audit.
- Build
  - Initial build failed on Swift 6 due to `Sendable` constraints; fixed by marking `ImageHydrator` as `@unchecked Sendable` to allow storing `FileManager` (non-Sendable) safely (Sources/Toolsmith/Virtualization/ImageHydrator.swift).
- Tests
  - Test suite compilation currently fails on macOS due to unconditional `import FoundationNetworking` in tests. Suggest wrapping in `#if canImport(FoundationNetworking)` (Tests/ToolsmithAPITests/APIClientTests.swift, Tests/ToolsmithTests/*.swift).
  - VM lifecycle tests validate checksum verification, mode resolution, and lifecycle log emission.

## Documentation & Observability

- Logging
  - Lifecycle events implemented: `download_start`, `download_end`, `checksum_verified`, `vm_boot`, `command_dispatch`, `shutdown` (Sources/Toolsmith/JSONLogger.swift).
  - Final `LogEntry` includes `execution_mode` and optional `span_id`; OpenTelemetry export is conditional on `OTEL_EXPORT_URL` env.
- User docs
  - README documents VM-first model, env toggles, and adapter usage (README.md).
  - `docs/index.md` includes verification steps and sample lifecycle logs.

## Image Repository (fountainkit-toolsmith-image)

- Build automation
  - `build/build-image.sh` provisions Ubuntu 22.04 cloud image; installs base packages, injects SSH keys, hardens SSH, resizes disk, and syspreps.
  - Generates SHA-256 checksum and stages artifacts under `dist/`.
- Validation
  - `docs/validation.md` provides a QEMU boot-and-SSH smoke test suite; references a `scripts/validate.sh` helper (script not present yet).
- Manifests
  - `manifests/tools.json` contains a catalog-style entry (`toolsmith.images[...]`) with `name`, `version`, `qcow2`, and `qcow2_sha256` placeholders.
  - Mismatch with Toolsmith’s consumer manifest shape, which expects:
    ```json
    { "image": { "name": "…", "tarball": "…", "sha256": "…", "qcow2": "…", "qcow2_sha256": "…" }, "tools": { }, "operations": [] }
    ```
  - Recommendation: either generate a consumer-ready `.toolsmith/tools.json` fragment alongside the catalog or adjust Toolsmith to ingest the catalog format.

## Gaps & Recommendations

1. Command channel integration
   - Implement a guest-side agent listening on `:3023` (or align to SSH) to transmit stdout/stderr updates and status codes.
   - Extend `CommandChannelAdapter` to speak the actual protocol and stream updates.
2. Manifest alignment
   - Decide on a single authoritative manifest shape. Provide a conversion step or update `ToolManifest` to support the image repo format.
3. Test portability
   - Guard `import FoundationNetworking` with `#if canImport(FoundationNetworking)` in tests to allow macOS builds to pass.
4. Tooling docs
   - Add the missing `scripts/validate.sh` referenced in docs, or update docs with manual validation steps only.
5. Telemetry examples
   - Include a short section showing how to set `OTEL_EXPORT_URL` and sample exported span payloads for users to confirm OTEL integration.

## Verification Checklist (as of this audit)

- Build: OK after minimal concurrency fix (Swift 6.1, macOS).
- Tests: Not fully passing on macOS due to `FoundationNetworking` imports.
- VM hydration/caching/checksum: Implemented and covered by tests.
- Lifecycle logging: Implemented and covered by tests.
- Command channel: Placeholder only; no real guest transport yet.
- Image repo: Build and validation scaffolding present; release and manifest details pending first image publication.

—
Audit authored on 2025‑10‑04.


name: Build And Publish Now

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: Tag to use for GHCR image (suffix only)
        required: false
        default: ci-${{ github.run_id }}
  push:
    branches:
      - ci/build-now/**

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            qemu-utils libguestfs-tools curl ca-certificates

      - name: Generate CI SSH key for image provisioning
        id: genkey
        run: |
          ssh-keygen -t ed25519 -N "" -f /tmp/toolsmith_ci_key
          echo "pub_key=$(cat /tmp/toolsmith_ci_key.pub)" >> $GITHUB_OUTPUT

      - name: Write authorized_keys for image
        run: |
          set -euo pipefail
          mkdir -p vendor/fountainkit-toolsmith-image/build
          echo "${{ steps.genkey.outputs.pub_key }}" > vendor/fountainkit-toolsmith-image/build/ci_authorized_keys

      - name: Build QCOW2 image
        id: build
        working-directory: vendor/fountainkit-toolsmith-image
        env:
          LIBGUESTFS_BACKEND: direct
          IMAGE_VERSION: ci-${{ github.run_id }}
          AUTHORIZED_KEYS: ${{ github.workspace }}/vendor/fountainkit-toolsmith-image/build/ci_authorized_keys
        run: |
          set -euo pipefail
          sudo -E bash build/build-image.sh
          # Find the produced qcow2
          QCOW2=$(ls -1 dist/*.qcow2 | head -n1)
          echo "qcow2_path=${QCOW2}" >> "$GITHUB_OUTPUT"

      - name: Publish to GHCR using reusable workflow
        uses: ./.github/workflows/publish-oci.yml
        with:
          qcow2_path: ${{ steps.build.outputs.qcow2_path }}
          image_ref: ghcr.io/${{ github.repository }}:${{ inputs.image_tag || format('ci-{0}', github.run_id) }}

